==============================
Quickstart
==============================

BaDORM example
---------------------------

To quickly understand how to use BaDORM, you can head to the 
`example <https://github.com/ditrit/badorm-example>`_, where you will find two different variations:

- `standalone/` where BaDORM is used in the simplest possible way.
- `fx/` where BaDORM is used within the :ref:`fx dependency injection system <badorm/concepts:dependency injection>`

File structure
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Both variations follow the same file structure:

- In `main.go` you will find the configuration required to use the BaDORM.
- In `example.go` you will find the actual example, where objects are created and then queried using BaDORM.
- In `models.go` you will find the :ref:`models <badorm/concepts:model>` definition.
- In `conditions/badorm.go` you will find the file that allows the :ref:`conditions generation <badorm/concepts:conditions generation>`.

Generate conditions
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

After choosing the example you want to run (`cd standalone` or `cd fx`) 
you will need to :ref:`generate the conditions <badorm/concepts:conditions generation>` for the models using `BaDctl`.

Install `badctl`:

.. code-block:: bash

  go install github.com/ditrit/badaas/tools/badctl

Generate conditions:

.. code-block:: bash

  go generate ./...

Now you will find in `conditions/` the :ref:`conditions <badorm/concepts:condition>` generated by badctl 
that allow you query the models in `example.go` and in `models/badorm.go` the :ref:`relation getters <badorm/concepts:relation getter>`.

Run it
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

First, we need a database to store the data, in this case we will use CockroachDB:

.. code-block:: bash

  docker compose up -d

After that, we can run the application:

.. code-block:: bash

  go run .

And you should see something like:

.. code-block:: bash

  ...
  2023/07/20 16:36:22 Migration finished, setting up CRUD example

  2023/07/20 16:36:22 /home/user/go/pkg/mod/github.com/ditrit/badaas@v0.0.0-20230720140340-b3328f8087ae/badorm/query.go:113
  [2.915ms] [rows:0] SELECT products.* FROM "products" WHERE "products"."deleted_at" IS NULL
  2023/07/20 16:36:22 Creating models

  2023/07/20 16:36:22 /home/user/go/pkg/mod/github.com/ditrit/badaas@v0.0.0-20230720140340-b3328f8087ae/badorm/crudRepository.go:51
  [13.587ms] [rows:1] INSERT INTO "products" ("id","created_at","updated_at","deleted_at","string","int","float","bool") VALUES ('c1be925a-1704-4e74-92b0-92103c54dda4','2023-07-20 16:36:22.778','2023-07-20 16:36:22.778',NULL,'',1,0.000000,false)

  2023/07/20 16:36:22 /home/user/go/pkg/mod/github.com/ditrit/badaas@v0.0.0-20230720140340-b3328f8087ae/badorm/crudRepository.go:51
  [10.760ms] [rows:1] INSERT INTO "products" ("id","created_at","updated_at","deleted_at","string","int","float","bool") VALUES ('bb0de001-d5e5-41fd-9805-b7c66e0f3f7f','2023-07-20 16:36:22.792','2023-07-20 16:36:22.792',NULL,'',2,0.000000,false)

  2023/07/20 16:36:22 /home/user/ditrit/badaas/badorm-example/standalone/example.go:46
  [12.193ms] [rows:1] INSERT INTO "companies" ("id","created_at","updated_at","deleted_at","name") VALUES ('40baea65-8502-4760-bff4-a738403a32ec','2023-07-20 16:36:22.803','2023-07-20 16:36:22.803',NULL,'ditrit')

  2023/07/20 16:36:22 /home/user/ditrit/badaas/badorm-example/standalone/example.go:53
  [10.426ms] [rows:1] INSERT INTO "companies" ("id","created_at","updated_at","deleted_at","name") VALUES ('1b5117fe-c03f-4332-ac7a-6b1748e8b382','2023-07-20 16:36:22.815','2023-07-20 16:36:22.815',NULL,'orness')

  2023/07/20 16:36:22 /home/user/ditrit/badaas/badorm-example/standalone/example.go:62
  [12.573ms] [rows:1] INSERT INTO "sellers" ("id","created_at","updated_at","deleted_at","name","company_id") VALUES ('e022a564-4c33-40ab-8dfd-34093e6a7c34','2023-07-20 16:36:22.825','2023-07-20 16:36:22.825',NULL,'franco','40baea65-8502-4760-bff4-a738403a32ec')

  2023/07/20 16:36:22 /home/user/ditrit/badaas/badorm-example/standalone/example.go:70
  [8.286ms] [rows:1] INSERT INTO "sellers" ("id","created_at","updated_at","deleted_at","name","company_id") VALUES ('7446b46a-dfcf-4d4c-bd46-37701e5f1492','2023-07-20 16:36:22.838','2023-07-20 16:36:22.838',NULL,'agustin','1b5117fe-c03f-4332-ac7a-6b1748e8b382')

  2023/07/20 16:36:22 /home/user/ditrit/badaas/badorm-example/standalone/example.go:79
  [2.412ms] [rows:0] INSERT INTO "products" ("id","created_at","updated_at","deleted_at","string","int","float","bool") VALUES ('c1be925a-1704-4e74-92b0-92103c54dda4','2023-07-20 16:36:22.778','2023-07-20 16:36:22.778',NULL,'',1,0.000000,false) ON CONFLICT DO NOTHING

  2023/07/20 16:36:22 /home/user/ditrit/badaas/badorm-example/standalone/example.go:79
  [3.227ms] [rows:0] INSERT INTO "sellers" ("id","created_at","updated_at","deleted_at","name","company_id") VALUES ('e022a564-4c33-40ab-8dfd-34093e6a7c34','2023-07-20 16:36:22.825','2023-07-20 16:36:22.825',NULL,'franco','40baea65-8502-4760-bff4-a738403a32ec') ON CONFLICT DO NOTHING

  2023/07/20 16:36:22 /home/user/ditrit/badaas/badorm-example/standalone/example.go:79
  [16.087ms] [rows:1] INSERT INTO "sales" ("id","created_at","updated_at","deleted_at","product_id","seller_id") VALUES ('9c667744-039f-43d0-b61a-abf0799a8b76','2023-07-20 16:36:22.853','2023-07-20 16:36:22.853',NULL,'c1be925a-1704-4e74-92b0-92103c54dda4','e022a564-4c33-40ab-8dfd-34093e6a7c34')

  2023/07/20 16:36:22 /home/user/ditrit/badaas/badorm-example/standalone/example.go:87
  [1.251ms] [rows:0] INSERT INTO "products" ("id","created_at","updated_at","deleted_at","string","int","float","bool") VALUES ('bb0de001-d5e5-41fd-9805-b7c66e0f3f7f','2023-07-20 16:36:22.792','2023-07-20 16:36:22.792',NULL,'',2,0.000000,false) ON CONFLICT DO NOTHING

  2023/07/20 16:36:22 /home/user/ditrit/badaas/badorm-example/standalone/example.go:87
  [1.451ms] [rows:0] INSERT INTO "sellers" ("id","created_at","updated_at","deleted_at","name","company_id") VALUES ('7446b46a-dfcf-4d4c-bd46-37701e5f1492','2023-07-20 16:36:22.838','2023-07-20 16:36:22.838',NULL,'agustin','1b5117fe-c03f-4332-ac7a-6b1748e8b382') ON CONFLICT DO NOTHING

  2023/07/20 16:36:22 /home/user/ditrit/badaas/badorm-example/standalone/example.go:87
  [14.831ms] [rows:1] INSERT INTO "sales" ("id","created_at","updated_at","deleted_at","product_id","seller_id") VALUES ('7ea7cfcd-b182-4d0b-945b-596dc4c1706f','2023-07-20 16:36:22.866','2023-07-20 16:36:22.866',NULL,'bb0de001-d5e5-41fd-9805-b7c66e0f3f7f','7446b46a-dfcf-4d4c-bd46-37701e5f1492')
  2023/07/20 16:36:22 Finished creating models

  2023/07/20 16:36:22 /home/user/go/pkg/mod/github.com/ditrit/badaas@v0.0.0-20230720140340-b3328f8087ae/badorm/query.go:113
  [2.641ms] [rows:1] SELECT products.* FROM "products" WHERE products.int = 1 AND "products"."deleted_at" IS NULL
  2023/07/20 16:36:22 Products with int = 1 are:
  &{UUIDModel:{ID:c1be925a-1704-4e74-92b0-92103c54dda4 CreatedAt:2023-07-20 16:36:22.778458 +0200 CEST UpdatedAt:2023-07-20 16:36:22.778458 +0200 CEST DeletedAt:{Time:0001-01-01 00:00:00 +0000 UTC Valid:false}} String: Int:1 Float:0 Bool:false}

Understand it (optional)
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

In this section we will see the steps carried out to develop this example.

**Standalone**

Once you have started your project with `go init`, you must add the dependency to BaDaaS and others:

.. code-block:: bash

    go get -u github.com/ditrit/badaas gorm.io/gorm

In models.go the :ref:`models <badorm/concepts:model>` are defined and 
in conditions/badorm.go the file required to 
:ref:`generate the conditions <badorm/concepts:conditions generation>` is created.

In main.go a main function is created with the configuration required to use the BaDORM. 
First, we need to create a :ref:`gormDB <badorm/concepts:gormDB>` that allows connection with the database:

.. code-block:: go

    gormDB, err := NewGormDBConnection()

After that, we have to call the :ref:`AutoMigrate <badorm/concepts:auto migration>` 
method of the gormDB with the models you want to be persisted::

    err = gormDB.AutoMigrate(
      models.Product{},
      models.Company{},
      models.Seller{},
      models.Sale{},
    )

From here, we can start to use BaDORM, getting the :ref:`CRUDService <badorm/concepts:CRUDService>` 
and :ref:`CRUDRepository <badorm/concepts:CRUDRepository>` of a model with the GetCRUD function:

.. code-block:: go

    crudProductService, crudProductRepository := badorm.GetCRUD[models.Product, badorm.UUID](gormDB)

As you can see, we need to specify the type of the model and the kind 
of :ref:`id <badorm/concepts:model ID>` this model uses.

Finally, you can use this service and repository to perform CRUD operations on your model:

.. code-block:: go

  CreateCRUDObjects(gormDB, crudProductRepository)
  QueryCRUDObjects(crudProductService)

This two functions are defined in `example.go`. 
In `QueryCRUDObjects` you can find a basic usage of the 
:ref:`compilable query system <badorm/concepts:compilable query system>`.

**Fx**

Once you have started your project with `go init`, you must add the dependency to BaDaaS and others:

.. code-block:: bash

  go get -u github.com/ditrit/badaas github.com/uber-go/fx github.com/uber-go/zap gorm.io/gorm

In models.go the :ref:`models <badorm/concepts:model>` are defined and 
in conditions/badorm.go the file required to 
:ref:`generate the conditions <badorm/concepts:conditions generation>` is created.

In main.go a main function is created with the configuration required to use the BaDORM with fx. 
First, we will need to start your application with `fx`:

.. code-block:: go

    func main() {
      fx.New(
        // activate BaDORM
        fx.Provide(NewLogger),
        fx.Provide(NewGormDBConnection),
        fx.Provide(GetModels),
        badorm.BaDORMModule,

        // logger for fx
        fx.WithLogger(func(logger *zap.Logger) fxevent.Logger {
          return &fxevent.ZapLogger{Logger: logger}
        }),

        // start example data
        badorm.GetCRUDServiceModule[models.Company](),
        badorm.GetCRUDServiceModule[models.Product](),
        badorm.GetCRUDServiceModule[models.Seller](),
        badorm.GetCRUDServiceModule[models.Sale](),

        fx.Provide(CreateCRUDObjects),
        fx.Invoke(QueryCRUDObjects),
      ).Run()
    }

There are some things you need to provide to the BaDORM module:

- `NewLogger` (optional) in this case we will use the zap logger instead of the gorm logger, 
  so we have to provide it and then use it as a logger for fx. 
  For more information visit :doc:`logger`.
- `NewGORMDBConnection` is the function that we need to create 
  a :ref:`gormDB <badorm/concepts:gormDB>` that allows connection with the database.
- `GetModels` is a function that returns in a `badorm.GetModelsResult` the list of models 
  you want to be persisted by the :ref:`auto migration <badorm/concepts:auto migration>`.

After that, we need to start the `badorm.BaDORMModule` and we are ready create 
:ref:`CRUDServices <badorm/concepts:CRUDService>` to your models using `badorm.GetCRUDServiceModule`.

Finally, we call the functions `CreateCRUDObjects` 
and `QueryCRUDObjects` where the CRUDServices are injected to create, 
read, update and delete the models easily. This two functions are defined in `example.go`. 
In `QueryCRUDObjects` yoIn `QueryCRUDObjects` you can find a basic usage of the compiled query system.u can find a basic usage of the 
:ref:`compilable query system <badorm/concepts:compilable query system>`.

BaDaaS example
---------------------------

If you are interested in using BaDORM within a BaDaaS application you can 
consult the `badaas example <https://github.com/ditrit/badaas-example>`_. 
in which besides using the services and repositories provided by BaDorm, 
BaDaaS adds a controller that allows the query of objects via an http api.